# 时间工具集成文档

## 🎯 功能说明

成功添加了 `get_current_time` 工具，解决了模型不知道当前时间的问题。该工具是一个轻量级、开箱即可用的实用工具，现在模型可以：
1. 获取准确的当前日期、时间、星期
2. 在搜索新闻时自动附带当前日期
3. 正确理解"今天"、"最近"等时间概念

## 📝 添加的工具

### `get_current_time` 工具

```python
@tool
async def get_current_time() -> str:
    """
    获取当前的日期和时间信息
    
    当用户询问"今天"、"现在"、"当前时间"等与时间相关的问题时，
    使用此工具获取准确的时间信息。
    """
```

**返回格式：**
```
当前时间信息：
📅 日期: 2025年11月22日
📆 星期: 星期六
🕐 时间: 15:53:46
🌍 完整时间: 2025-11-22 15:53:46

提示：在搜索时事新闻或最新信息时，请在搜索查询中包含此日期，以获得更准确的结果。
```

## 🔄 工作流程

### 场景 1: 用户问"今天有什么AI新闻"

```
用户提问: "今天有什么人工智能的新闻？"
   ↓
模型识别需要时间信息
   ↓
调用 get_current_time 工具
   ↓
获取: 2025年11月22日
   ↓
调用 search_recent_news("人工智能")
   ↓
内部自动构造查询: "2025年11月22日 人工智能 最近7天 新闻"
   ↓
返回带日期的搜索结果
   ↓
模型基于结果生成回答
```

### 场景 2: 用户问"现在几点"

```
用户提问: "现在几点了？"
   ↓
调用 get_current_time 工具
   ↓
返回完整时间信息
   ↓
模型直接回答
```

## 🛠️ 修改内容

### 1. web_search_tool.py

**添加了 `get_current_time` 工具：**
- 返回详细的时间信息（日期、时间、星期）
- 包含使用提示

**优化了 `search_recent_news` 工具：**
- 自动在查询中添加当前日期
- 查询格式: `"{当前日期} {主题} 最近{天数}天 新闻"`

**更新了工具列表：**
```python
WEB_SEARCH_TOOLS = [
    web_search,
    search_recent_news,
    get_current_time  # 新增
]
```

### 2. main.py

**更新了系统提示词：**
```python
工具使用指南（重要）：
- 当用户询问"今天"、"现在"、"最近"等与时间相关的问题时，
  必须先调用 get_current_time 工具获取当前日期
- 在搜索实时新闻或最新信息时，应该先获取当前时间，
  然后在搜索查询中包含日期信息
- 例如：用户问"今天有什么AI新闻" 
  -> 先调用 get_current_time，再调用 web_search 或 search_recent_news
```

## 📊 测试结果

```bash
python test_time_tool.py
```

输出：
```
当前时间信息：
📅 日期: 2025年11月22日
📆 星期: 星期六
🕐 时间: 15:53:46

搜索查询: "2025年11月22日 人工智能 最近3天 新闻"
✅ 搜索完成，找到 1 条结果
```

## 🎨 前端显示（可选）

如果想在前端显示工具调用过程：

```typescript
// 检测到工具调用
{
  "type": "tool_calls",
  "tools": [
    {
      "name": "get_current_time",
      "args": {}
    }
  ]
}

// 工具返回结果
{
  "type": "tool_results",
  "results": [
    {
      "tool": "get_current_time",
      "content": "当前时间信息：\n📅 日期: 2025年11月22日\n..."
    }
  ]
}

// 显示为: "🕐 正在获取当前时间..."
```

## 💡 使用示例

### 示例 1: 查询今天的新闻
```
用户: "今天有什么关于人工智能的新闻？"

后端处理:
1. 调用 get_current_time() → "2025年11月22日"
2. 调用 search_recent_news("人工智能", 7)
   → 实际搜索: "2025年11月22日 人工智能 最近7天 新闻"
3. 返回搜索结果并生成回答

模型回答: "今天（2025年11月22日）关于人工智能的新闻有..."
```

### 示例 2: 查询当前时间
```
用户: "现在几点了？"

后端处理:
1. 调用 get_current_time()
2. 直接返回时间信息

模型回答: "现在是2025年11月22日，星期六，15:53:46。"
```

### 示例 3: 结合文档和时间搜索
```
用户上传了一份2023年的AI报告，然后问:
"这份报告的内容和现在的情况相比如何？"

后端处理:
1. 读取PDF内容（RAG）
2. 调用 get_current_time() → "2025年11月22日"
3. 调用 web_search("2025年人工智能最新进展")
4. 综合PDF内容和搜索结果回答

模型回答: "根据您提供的2023年报告[1]，当时的技术水平是...
而根据最新的搜索结果，截至2025年11月22日，现在的进展包括..."
```

## ⚙️ 配置说明

无需额外配置！工具开箱即用。

**自动启用条件：**
- 只在 `deepseek-chat` 模型中启用
- `deepseek-reasoner` 和视觉模型不支持工具调用

若需要在受控环境中禁用该工具，可在 `main.py` 的调用入口处将 `enable_tools` 设为 `False`，或在 `config.py` 中添加相应开关并在 `get_chat_model_with_tools` 中读取配置。

## 🚀 优势

✅ **时间感知** - 模型现在知道当前日期和时间  
✅ **准确搜索** - 搜索新闻时自动带上日期  
✅ **智能调用** - 模型自动判断何时需要获取时间  
✅ **详细信息** - 返回日期、时间、星期等完整信息  
✅ **用户友好** - 提供清晰的时间格式化输出  

## 🔍 调试技巧

查看工具调用日志：
```bash
tail -f logs/app.log | grep "工具"
```

你会看到：
```
🕐 返回当前时间: 2025-11-22 15:53:46
🔧 执行工具: get_current_time, 参数: {}
✅ 工具执行成功: get_current_time
📰 搜索最近新闻: 人工智能 (最近3天)
🔍 开始搜索: 2025年11月22日 人工智能 最近3天 新闻
```

## 📦 完整工具列表

现在系统支持以下工具：

1. **web_search** - 通用网络搜索
2. **search_recent_news** - 搜索最近新闻（自动带日期）
3. **get_current_time** - 获取当前时间 ⭐ 新增

模型会智能地组合使用这些工具来回答问题！

---

现在你的 RAG 系统具备了完整的时间感知能力，可以准确回答关于"今天"、"最近"的问题了！🎉
